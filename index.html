<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boring Editor</title>
    <link rel="stylesheet" href="./app.min.css">
</head>

<body class="bg-dark text-light" spellcheck="false">
    <nav class="navbar bg-dark navbar-dark shadow">
        <button class="navbar-toggler" data-target="#navbar-col" style="font-size: 1.3rem;">
            <svg data-v-3fe0c21f="" class="svg-inline--fa fa-bars fa-w-14" aria-hidden="true" focusable="false"
                data-prefix="fas" data-icon="bars" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"
                data-fa-i2svg="" style="width: 100%;">
                <path fill="currentColor"
                    d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z">
                </path>
            </svg>
        </button>
        <div class="navbar-collapse" id="navbar-col">
            <ul class="align-items-center">
                <li><a class="navbar-link" data-toggle="dropdown" data-target="#file">File</a></li>
                <div class="dropdown bg-dark bd-secondary" id="file">
                    <ul>
                        <li><a class="text-light">
                                <div>
                                    New
                                </div>
                            </a></li>
                        <li><a class="text-light" data-target="#save" data-toggle="modal">
                                <div>
                                    Save
                                </div>
                            </a></li>
                        <li><a class="text-light">
                                <div>
                                    Save as
                                </div>
                            </a></li>
                    </ul>
                </div>
                <li><a class="navbar-link" data-toggle="dropdown" data-target="#edit">Edit</a></li>
                <div class="dropdown bg-dark bd-secondary" id="edit">
                    <ul>
                        <li><a class="text-light">
                                <div>
                                    Undo
                                </div>
                            </a></li>
                        <li><a class="text-light">
                                <div>
                                    Redo
                                </div>
                            </a></li>
                        <li><a class="text-light">
                                <div>
                                    Cut
                                </div>
                            </a></li>
                            <li><a class="text-light">
                                <div>
                                    Copy
                                </div>
                            </a></li>
                    </ul>
                </div>
                <li><a class="navbar-link" data-toggle="dropdown" data-target="#help">Help</a></li>
                <div class="dropdown bg-dark bd-secondary" id="help">
                    <ul>
                        <li><a class="text-light" href="https://github.com/pwnrrk/boring-editor/issue" target="_blank">
                            <div>
                                Report or View issue
                            </div>
                        </a></li>
                        <li><a class="text-light" href="https://github.com/pwnrrk/boring-editor/blob/master/LICENSE">
                                <div>
                                    View Licence
                                </div>
                            </a></li>
                        <li><a class="text-light" href="https://pwnrrk.github.io">
                                <div>
                                    Contributor
                                </div>
                            </a></li>
                            <li><a class="text-light" href="https://github.com/pwnrrk/boring-editor#readme">
                                <div>
                                    About
                                </div>
                            </a></li>
            </ul>
            </ul>
            <ul class="justify-content-end align-items-center">
                <li>
                    <div id="autosaving" class="mr-1 autosaving">Auto saving...</div>
                </li>
                <li>
                    <div class="mr-1"><input type="text" class="form-item text-light" placeholder="File name"
                            id="filename">
                    </div>
                </li>
                <li><a class="navbar-link active btn btn-primary mr-1" data-target="#save" data-toggle="modal">Save</a>
                </li>
            </ul>
        </div>
    </nav>
    <div style="height: 90vh;overflow: auto;width: 100%;cursor:text;" id="wrapper">
        <div class="flex" style="width: 100%;">
            <div style="width:fit-content;padding: 0rem 1rem 0rem 1rem;display: flex;flex-direction: column;align-items: flex-end;line-height: 20px;min-height: 100vh;"
                id="line">

            </div>
            <div contenteditable="true" class="type-area col" style="line-height: 20px;height:100%;" id="editor"></div>
        </div>
    </div>
    <div class="modal fade modal-sm static" id="save" tabindex="-1" role="dialog" aria-labelledby="save"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark bd-secondary">
                <div class="modal-header">
                    <div class="modal-title text-center"></div>
                </div>
                <div class="modal-body">
                    <h2 class="text-center">Save file?</h2>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="save()">Save</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade modal-sm static" id="save-as" tabindex="-1" role="dialog" aria-labelledby="save-as"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content bg-dark bd-secondary">
                <div class="modal-header">
                    <div class="modal-title text-center">Save as</div>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="filename" class="form-item-label">File name</label>
                        <input type="text" class="form-item text-light" placeholder="File name" id="save-as-filename">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="saveAs()">Save</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="https://pwnrrk.github.io/minimalbootstrap/minbootstrap/js/minBootstrap.min.js"></script>
<script>
    //Element
    const editor = document.getElementById('editor')
    const wrapper = document.getElementById('wrapper')
    const line = document.getElementById('line')
    const filename = document.getElementById('filename')
    const autosaving = document.getElementById('autosaving')

    //Set default file name
    filename.value = 'untitled.txt'

    //Get temp file name
    if (localStorage.getItem('filename')) {
        filename.value = localStorage.getItem('filename')
    }

    //Get temp content
    if (localStorage.getItem('tempEditor')) {
        editor.innerText = localStorage.getItem('tempEditor')
        linenumber()
    }

    //Set title from file name
    document.title = filename.value

    //Add line number and save to temp
    editor.addEventListener('keyup', event => {
        linenumber()
        autosave()
    })

    //Save file name to temp
    filename.addEventListener('keyup', event => {
        localStorage.setItem('filename', filename.value)
        document.title = filename.value
    })

    //Add line number 
    function linenumber() {
        let lines = countLines()
        let template = document.createDocumentFragment()
        for (let i = 0; i < lines; i++) {
            let div = document.createElement('div')
            div.textContent = (i + 1)
            template.appendChild(div)
        }
        line.innerHTML = ''
        line.appendChild(template)
    }

    //Count line
    function countLines() {

        // Get element with 'content' as id                             
        var el = editor;

        // Get total height of the content     
        var divHeight = el.offsetHeight

        // object.style.lineHeight, returns  
        // the lineHeight property 
        // height of one line
        var lineHeight = parseInt(el.style.lineHeight);
        var lines = divHeight / lineHeight;
        return lines
    }

    //Auto save
    function autosave() {
        setTimeout(() => {
            if (!autosaving.classList.contains('showing')) {
                autosaving.classList.add('showing')
            }
            let text = editor.innerText
            localStorage.setItem('tempEditor', text)
        }, 700)
        setTimeout(() => {

            autosaving.classList.remove('showing')
        }, 2500)
    }

    //Save to file
    function save() {
        // Convert the text to BLOB.
        const textToBLOB = new Blob([editor.innerText], { type: 'text/plain' });
        const sFileName = filename.value;	   // The file to save the data.

        let newLink = document.createElement("a");
        newLink.download = sFileName;

        if (window.webkitURL != null) {
            newLink.href = window.webkitURL.createObjectURL(textToBLOB);
        }
        else {
            newLink.href = window.URL.createObjectURL(textToBLOB);
            newLink.style.display = "none";
            document.body.appendChild(newLink);
        }

        newLink.click();
    }

    //Send user to editor
    document.addEventListener('click', e => {
        if (e.target == wrapper || e.target != editor && wrapper.contains(e.target) && editor.innerText == '') {
            editor.focus()
        }
    })

    //Tab insert
    window.addEventListener("keydown", insertTabAtCaret);

    function insertTabAtCaret(event) {
        if (event.keyCode == 9) {
            event.preventDefault()
            var range = window.getSelection().getRangeAt(0);

            var tabNode = document.createTextNode("\u00a0\u00a0\u00a0\u00a0");
            range.insertNode(tabNode);

            range.setStartAfter(tabNode);
            range.setEndAfter(tabNode);
            def = true
        }
    }

    //Disable scroll by space bar
    window.onkeydown = function (e) {
        return !(e.keyCode == 32 && e.target == document.body);
    };
</script>

</html>